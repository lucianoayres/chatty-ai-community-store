name: Update Agent Index

on:
  push:
    branches:
      - main
    paths:
      - "agents/**.yaml"

jobs:
  update-index:
    name: Update Agent Index
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for proper comparison

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install pyyaml jsonschema yamale

      - name: Validate changed agent files
        id: validation
        continue-on-error: false
        run: |
          # Get list of changed files (removed grouping to ensure errors are visible)
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep "^agents/.*\.yaml$" || echo "")
          echo "Changed agent files:"
          echo "$CHANGED_FILES"

          if [ -z "$CHANGED_FILES" ]; then
            echo "No agent YAML files were changed."
            echo "validation_passed=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Setup validation environment
          export PYTHONPATH="$PWD/tools/agent_manager/src:$PYTHONPATH"

          # Validate each changed file
          mkdir -p validation_logs
          VALIDATION_LOG="validation_logs/validation_results.txt"
          ERROR_SUMMARY="validation_logs/error_summary.txt"
          echo "Validation results:" > $VALIDATION_LOG
          echo "====================" >> $VALIDATION_LOG
          echo "" >> $VALIDATION_LOG

          FAIL_COUNT=0
          echo "" > $ERROR_SUMMARY

          for file in $CHANGED_FILES; do
            echo "===== Validating $file ====="
            
            # Run the validator with all output directly visible
            python tools/agent_manager/src/validator.py \
              --yaml-schema schemas/agent.schema.yaml \
              --file "$file" \
              --tag-definitions tags.json \
              --verbose
            
            VALIDATION_EXIT_CODE=$?
            
            # Capture the same command output to save in logs
            VALIDATION_OUTPUT=$(python tools/agent_manager/src/validator.py \
              --yaml-schema schemas/agent.schema.yaml \
              --file "$file" \
              --tag-definitions tags.json \
              --verbose \
              2>&1)
              
            # Save to log file
            echo "Validating $file..." >> $VALIDATION_LOG
            echo "-----------------------------------------" >> $VALIDATION_LOG
            echo "$VALIDATION_OUTPUT" >> $VALIDATION_LOG
            echo "-----------------------------------------" >> $VALIDATION_LOG
            echo "" >> $VALIDATION_LOG
            
            # Check if validation failed
            if [ $VALIDATION_EXIT_CODE -ne 0 ]; then
              FAIL_COUNT=$((FAIL_COUNT+1))
              
              # Add error details to summary for easy reference
              echo "❌ File: $file" | tee -a $ERROR_SUMMARY
              
              # Extract errors and display them directly with annotations
              ERROR_DETAILS=$(echo "$VALIDATION_OUTPUT" | grep -E "Error:|Warning:|Missing|Invalid|failed|required" | head -10)
              
              if [ -n "$ERROR_DETAILS" ]; then
                # Force display error to stderr
                echo "VALIDATION ERRORS:" >&2
                echo "$ERROR_DETAILS" >&2
                echo "" >&2
                
                # Add each line as a GitHub error annotation
                echo "$ERROR_DETAILS" | while read -r line; do
                  echo "::error file=$file::$line"
                done
                
                # Add to summary
                echo "  Error details:" >> $ERROR_SUMMARY
                echo "$ERROR_DETAILS" | sed 's/^/  /' >> $ERROR_SUMMARY
              else
                # If no specific errors found, display the last few lines
                ERROR_DETAILS=$(echo "$VALIDATION_OUTPUT" | tail -5)
                
                # Force display error to stderr
                echo "VALIDATION ERRORS:" >&2
                echo "$ERROR_DETAILS" >&2
                echo "" >&2
                
                # Add to summary
                echo "  Error details:" >> $ERROR_SUMMARY
                echo "$ERROR_DETAILS" | sed 's/^/  /' >> $ERROR_SUMMARY
              fi
              
              echo "" >> $ERROR_SUMMARY
            else
              echo "✅ File passed validation: $file"
            fi
            
            echo ""
          done

          # Determine overall result
          if [ $FAIL_COUNT -gt 0 ]; then
            # Print error summary to make it clearly visible in workflow logs
            echo ""
            echo "============================================="
            echo "❌ VALIDATION FAILED: $FAIL_COUNT files have issues" >&2
            echo "============================================="
            echo ""
            # Display the error summary in the console
            cat $ERROR_SUMMARY
            
            # Create GitHub annotations for key errors
            echo "::error::Validation failed with $FAIL_COUNT error(s). See details above."
            
            # Save the outputs but don't print the full log in the console
            echo "validation_passed=false" >> $GITHUB_OUTPUT
            echo "fail_count=$FAIL_COUNT" >> $GITHUB_OUTPUT
            echo "error_summary<<EOF" >> $GITHUB_OUTPUT
            cat $ERROR_SUMMARY >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo ""
            echo "Complete validation log saved as an artifact"
            
            exit 1
          else
            echo "validation_passed=true" >> $GITHUB_OUTPUT
            echo "✅ All agent files passed validation!"
          fi

      - name: Upload validation results
        if: steps.validation.outputs.validation_passed == 'false' || failure()
        uses: actions/upload-artifact@v4
        with:
          name: validation-results
          path: validation_logs/

      - name: Run manage_agents.sh script
        id: update-index
        if: steps.validation.outputs.validation_passed == 'true' && success()
        run: |
          echo "::group::Updating Agent Index"
          # Only run if validation passed
          bash tools/agent_manager/manage_agents.sh

          # Check if index file was modified
          if git diff --name-only | grep -q "agent_index.json"; then
            echo "index_updated=true" >> $GITHUB_OUTPUT
            echo "Agent index was updated!"
          else
            echo "index_updated=false" >> $GITHUB_OUTPUT
            echo "No changes to agent index."
          fi
          echo "::endgroup::"

      - name: Commit updated index
        if: steps.validation.outputs.validation_passed == 'true' && steps.update-index.outputs.index_updated == 'true' && success()
        run: |
          # Configure git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Add and commit the changes
          git add agent_index.json
          git commit -m "🤖 Auto-update agent index [skip ci]" -m "Triggered by commit ${GITHUB_SHA}"

          # Push the changes
          git push

      - name: Find related PR
        if: steps.validation.outputs.validation_passed == 'true' && steps.update-index.outputs.index_updated == 'true' && success()
        id: find-pr
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            // Find the most recent PR that was merged into this branch
            const query = `
              query($owner:String!, $repo:String!) {
                repository(owner:$owner, name:$repo) {
                  pullRequests(last:10, states:MERGED, orderBy:{field:UPDATED_AT, direction:DESC}) {
                    nodes {
                      number
                      title
                      mergedAt
                      url
                      mergeCommit {
                        oid
                      }
                    }
                  }
                }
              }
            `;

            const variables = {
              owner: context.repo.owner,
              repo: context.repo.repo
            };

            const result = await github.graphql(query, variables);
            const prs = result.repository.pullRequests.nodes;

            // Try to find a PR that matches the current commit
            let relatedPR = null;
            const targetCommit = context.payload.after;

            for (const pr of prs) {
              if (pr.mergeCommit && pr.mergeCommit.oid === targetCommit) {
                relatedPR = pr;
                break;
              }
            }

            if (relatedPR) {
              core.setOutput('pr_number', relatedPR.number);
              core.setOutput('pr_title', relatedPR.title);
              core.setOutput('pr_url', relatedPR.url);
              return relatedPR;
            } else {
              console.log('Could not find related PR for this commit');
              return null;
            }

      - name: Comment on PR
        if: steps.validation.outputs.validation_passed == 'true' && steps.update-index.outputs.index_updated == 'true' && steps.find-pr.outputs.pr_number != '' && success()
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const prNumber = ${{ steps.find-pr.outputs.pr_number }};

            if (!prNumber) {
              console.log('No PR number found, skipping comment');
              return;
            }

            const body = `## 🤖 Agent Index Updated

            The agent index has been automatically updated following the merge of this PR.

            [View the updated index](${context.payload.repository.html_url}/blob/main/agent_index.json)
            `;

            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Create issue for validation failure
        if: steps.validation.outputs.validation_passed == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const fs = require('fs');

            // Get the error summary which is already concise
            let errorSummary = '';

            try {
              errorSummary = '${{ steps.validation.outputs.error_summary }}';
              
              // If errorSummary is empty or too short, read from the file
              if (!errorSummary || errorSummary.length < 10) {
                errorSummary = fs.readFileSync('validation_logs/error_summary.txt', 'utf8');
              }
            } catch (error) {
              errorSummary = 'Error reading validation summary: ' + error.message;
            }

            const issue = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '🚨 Agent validation failed on direct push to main',
              body: `One or more agent YAML files that were pushed directly to the main branch failed validation.
              
              **⚠️ The agent index was NOT updated due to validation failure.**
              
              Triggered by: ${context.payload.head_commit.message}
              Commit: ${context.payload.head_commit.id}
              Workflow run: ${context.payload.repository.html_url}/actions/runs/${context.runId}
              
              ## Validation Error Summary
              
              \`\`\`
              ${errorSummary}
              \`\`\`
              
              Please fix the validation issues and push again, or create a PR to resolve the issues.
              
              > **Note**: Full validation logs are available in the workflow run artifacts.
              `
            };

            github.rest.issues.create(issue);

      - name: Notify on failure
        if: failure() && steps.validation.outputs.validation_passed != 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const issue = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '🚨 Failed to update agent index',
              body: `The workflow to update the agent index failed due to an unexpected error.
              
              Triggered by: ${context.payload.head_commit.message}
              Commit: ${context.payload.head_commit.id}
              Workflow run: ${context.payload.repository.html_url}/actions/runs/${context.runId}
              
              Please investigate and fix the issue.`
            };

            github.rest.issues.create(issue);
